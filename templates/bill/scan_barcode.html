{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Scan Barcode {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<!-- Select2 -->
<link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
<!-- Toastr -->
<link rel="stylesheet" href="{% static 'plugins/toastr/toastr.min.css' %}">
<style>
  #interactive.viewport {
    position: relative;
    width: 100%;
    height: 400px;
    overflow: hidden;
    text-align: center;
    border: 3px solid #ddd;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  
  #interactive.viewport img {
    max-width: 100%;
    max-height: 100%;
  }
  
  #scanned-books {
    max-height: 500px;
    overflow-y: auto;
  }
  
  .scan-result {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
  }
  
  .loading-spinner {
    display: none;
    text-align: center;
    margin: 20px 0;
  }
  
  /* Table styling */
  #scanned-books table {
    width: 100%;
  }
  
  #scanned-books table th,
  #scanned-books table td {
    vertical-align: middle;
  }
  
  #scanned-books table tfoot {
    font-weight: bold;
    background-color: #f4f6f9;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Scan Barcode</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'bill_list' %}">Bills</a></li>
            <li class="breadcrumb-item active">Scan Barcode</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Barcode Scanner</h3>
              <div class="card-tools">
                <a href="{% url 'bill_list' %}" class="btn btn-default ajax-link">
                  <i class="fas fa-arrow-left"></i> Back to Bills
                </a>
                <a href="{% url 'bill_create' %}" class="btn btn-primary ajax-link">
                  <i class="fas fa-plus"></i> New Bill
                </a>
              </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
              <div class="row">
                <div class="col-md-7">
                  <!-- Scanner Section -->
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">
                        <i class="fas fa-camera"></i> Camera Feed
                      </h3>
                      <div class="card-tools">
                        <a href="{% url 'bill_scan_barcode_desktop' %}" class="btn btn-success btn-sm">
                          <i class="fas fa-play"></i> Start Scanner (Desktop)
                        </a>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Clicking "Start Scanner" will open the camera on the server computer. 
                        You will see a camera window where barcodes will be scanned. Press 'c' key to complete scanning and return to the web interface.
                      </div>
                      
                      <form id="manual-barcode-form" class="form-group mt-3" onsubmit="return false;">
                        {% csrf_token %}
                        <label for="barcode-manual">Or enter barcode manually:</label>
                        <div class="input-group">
                          <input type="text" id="barcode-manual" class="form-control" placeholder="Enter barcode number">
                          <div class="input-group-append">
                            <button type="button" id="lookup-barcode" class="btn btn-primary">
                              <i class="fas fa-search"></i> Lookup
                            </button>
                          </div>
                        </div>
                      </form>
                      
                      <div class="loading-spinner" id="loading-spinner">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <div>Processing barcode...</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Customer Selection -->
                  <div class="card mt-3">
                    <div class="card-header">
                      <h3 class="card-title">
                        <i class="fas fa-user"></i> Customer Selection
                      </h3>
                    </div>
                    <div class="card-body">
                      <div class="form-group">
                        <label for="customer-select">Select Customer:</label>
                        <select class="form-control select2" id="customer-select" required>
                          <option value="">Select a customer</option>
                          {% for customer in customers %}
                          <option value="{{ customer.id }}">{{ customer.cusname }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-5">
                  <!-- Scanned Books Section -->
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">
                        <i class="fas fa-list"></i> Scanned Books
                      </h3>
                      <div class="card-tools">
                        <button type="button" id="create-bill-button" class="btn btn-primary btn-sm" disabled>
                          <i class="fas fa-shopping-cart"></i> Create Bill
                        </button>
                        <button type="button" id="clear-button" class="btn btn-warning btn-sm" disabled>
                          <i class="fas fa-trash"></i> Clear List
                        </button>
                      </div>
                    </div>
                    <div class="card-body">
                      <div id="scanned-books" class="scanned-books">
                        <div class="text-muted text-center">
                          <i class="fas fa-barcode fa-3x mb-3"></i>
                          <p>Scan a barcode to add books to the list.</p>
                        </div>
                      </div>
                      
                      <!-- Book Quantity Edit Modal -->
                      <div class="modal fade" id="quantityModal" tabindex="-1" role="dialog" aria-labelledby="quantityModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="quantityModalLabel">Edit Quantity</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                              <div class="form-group">
                                <label for="edit-book-title">Book:</label>
                                <input type="text" class="form-control" id="edit-book-title" readonly>
                                <input type="hidden" id="edit-book-index">
                              </div>
                              <div class="form-group">
                                <label for="edit-book-quantity">Quantity:</label>
                                <input type="number" class="form-control" id="edit-book-quantity" min="1" value="1">
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-primary" id="save-quantity">Save changes</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<!-- Select2 -->
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Toastr -->
<script src="{% static 'plugins/toastr/toastr.min.js' %}"></script>
<script>
// Configure toastr notifications
toastr.options = {
  "closeButton": true,
  "positionClass": "toast-top-right",
  "timeOut": "3000"
};

console.log("barcode_scanner.js loaded!");

$(function () {
  // Store scanned books
  var scannedBooks = [];
  
  // Extract CSRF token from the form
  var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();
  
  // Initialize Select2
  $('.select2').select2({
    theme: 'bootstrap4'
  });
  
  // Try to load books from session storage first
  var savedBooks = sessionStorage.getItem('scannedBooks');
  if (savedBooks) {
    try {
      scannedBooks = JSON.parse(savedBooks);
      updateScannedBooksList();
    } catch (e) {
      console.error("Error loading books from session storage:", e);
    }
  }
  
  // Then check if there are desktop scanned books from Django
  {% if desktop_scanned_books %}
    // Merge with existing books
    var desktopBooks = {{ desktop_scanned_books|safe }};
    
    // Add desktop books that aren't already in the list
    desktopBooks.forEach(function(newBook) {
      var exists = false;
      for (var i = 0; i < scannedBooks.length; i++) {
        if (scannedBooks[i].id === newBook.id) {
          exists = true;
          // Update quantity if it exists
          scannedBooks[i].quantity += newBook.quantity;
          break;
        }
      }
      if (!exists) {
        // Add scanned_by property if not present
        if (!newBook.hasOwnProperty('scanned_by')) {
          newBook.scanned_by = 'camera';
        }
        scannedBooks.push(newBook);
      }
    });
    
    updateScannedBooksList();
    toastr.info('Added camera-scanned books to the list');
  {% endif %}
  
  // Manual lookup form submission
  $('#manual-barcode-form').on('submit', function(e) {
    e.preventDefault(); // Prevent form submission
    var barcode = $('#barcode-manual').val().trim();
    if (barcode) {
      lookupBarcode(barcode);
      $('#barcode-manual').val('');
    }
    return false; // Ensure no submission occurs
  });
  
  // Manual lookup button click
  $('#lookup-barcode').on('click', function(e) {
    e.preventDefault(); // Prevent any default action
    var barcode = $('#barcode-manual').val().trim();
    if (barcode) {
      lookupBarcode(barcode);
      $('#barcode-manual').val('');
    } else {
      toastr.warning('Please enter a barcode number first');
    }
    return false; // Ensure no page refresh
  });
  
  // Also listen for keypress in the barcode input field
  $('#barcode-manual').on('keydown', function(e) {
    if (e.which === 13) { // Enter key
      e.preventDefault(); // Prevent form submission
      var barcode = $(this).val().trim();
      if (barcode) {
        lookupBarcode(barcode);
        $(this).val('');
      }
      return false; // Prevent default
    }
  });
  
  // Create bill button
  $('#create-bill-button').on('click', function() {
    createBillFromScannedBooks();
  });
  
  // Clear button
  $('#clear-button').on('click', function() {
    clearScannedBooks();
  });
  
  // Save quantity changes
  $('#save-quantity').on('click', function() {
    var index = parseInt($('#edit-book-index').val());
    var quantity = parseInt($('#edit-book-quantity').val());
    
    if (quantity >= 1 && index >= 0 && index < scannedBooks.length) {
      scannedBooks[index].quantity = quantity;
      $('#quantityModal').modal('hide');
      
      // Save to session storage
      sessionStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
      
      updateScannedBooksList();
      
      // Show success message
      toastr.success('Quantity updated successfully');
    }
  });
  
  // Handle Enter key in quantity input
  $('#edit-book-quantity').on('keypress', function(e) {
    if (e.which === 13) { // Enter key
      $('#save-quantity').click();
      e.preventDefault();
    }
  });
  
  // Lookup a barcode via API
  function lookupBarcode(barcode) {
    $('#loading-spinner').show();
    
    // Try the direct lookup first (no authentication needed)
    $.ajax({
      url: '/api/lookup_barcode/' + encodeURIComponent(barcode) + '/',
      type: 'GET',
      success: function(data) {
        if (data.success) {
          addBookToScannedList(data.book);
        } else {
          // Fall back to the POST method with CSRF
          lookupBarcodeWithPost(barcode);
        }
      },
      error: function(xhr) {
        // Fall back to the POST method with CSRF
        lookupBarcodeWithPost(barcode);
      },
      complete: function() {
        $('#loading-spinner').hide();
      }
    });
  }
  
  // Fallback method using POST with CSRF token
  function lookupBarcodeWithPost(barcode) {
    $.ajax({
      url: '/api/process_barcode/',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        barcode: barcode
      }),
      headers: {
        'X-CSRFToken': csrftoken
      },
      success: function(data) {
        if (data.success) {
          addBookToScannedList(data.book);
        } else {
          console.error("Invalid barcode response:", data);
          toastr.error("Could not find book with barcode: " + barcode);
          playSound('error');
        }
      },
      error: function(xhr) {
        console.error("Error looking up barcode:", xhr);
        toastr.error("Error looking up barcode: " + barcode);
        playSound('error');
      },
      complete: function() {
        $('#loading-spinner').hide();
      }
    });
  }
  
  // Function to add a book to the scanned list
  function addBookToScannedList(book) {
    // Check if book is already in the list
    var bookExists = false;
    for (var i = 0; i < scannedBooks.length; i++) {
      if (scannedBooks[i].id === book.id) {
        // Increment quantity instead of adding again
        scannedBooks[i].quantity++;
        bookExists = true;
        
        // Show notification for quantity update
        toastr.info('Updated quantity for "' + scannedBooks[i].description + '" to ' + scannedBooks[i].quantity);
        break;
      }
    }
    
    if (!bookExists) {
      // Add book to the list
      var newBook = {
        id: book.id,
        description: book.description,
        price: book.price,
        quantity: 1,
        publisher: book.publisher,
        authors: Array.isArray(book.authors) ? book.authors.join(', ') : book.authors,
        categories: Array.isArray(book.categories) ? book.categories.join(', ') : book.categories,
        scanned_by: 'manual'  // Track how this book was added
      };
      
      scannedBooks.push(newBook);
      
      // Show notification for new book
      toastr.success('Added "' + newBook.description + '" to list');
    }
    
    // Save to session storage
    sessionStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
    
    // Update the display
    updateScannedBooksList();
    
    // Play success sound
    playSound('success');
  }
  
  // Update the scanned books list
  function updateScannedBooksList() {
    var container = $('#scanned-books');
    container.empty();
    
    if (scannedBooks.length === 0) {
      container.html('<div class="text-muted text-center"><i class="fas fa-barcode fa-3x mb-3"></i><p>Scan a barcode to add books to the list.</p></div>');
      $('#create-bill-button').prop('disabled', true);
      $('#clear-button').prop('disabled', true);
      
      // Clear session storage when list is empty
      sessionStorage.removeItem('scannedBooks');
      return;
    }
    
    // Save to session storage
    sessionStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
    
    // Create a table to display books
    var tableHtml = '<table class="table table-striped table-hover">' +
      '<thead>' +
      '<tr>' +
      '<th>Book</th>' +
      '<th>Price</th>' +
      '<th>Qty</th>' +
      '<th>Total</th>' +
      '<th>Actions</th>' +
      '</tr>' +
      '</thead>' +
      '<tbody>';
    
    var total = 0;
    
    scannedBooks.forEach(function(book, index) {
      var bookTotal = parseFloat(book.price) * book.quantity;
      total += bookTotal;
      
      // Add a class for camera-scanned books
      var rowClass = '';
      var scanIcon = '';
      
      if (book.scanned_by === 'camera') {
        rowClass = 'class="table-info"';
        scanIcon = '<i class="fas fa-camera text-info mr-1" title="Camera scanned"></i>';
      } else if (book.scanned_by === 'manual') {
        rowClass = 'class="table-warning"';
        scanIcon = '<i class="fas fa-keyboard text-warning mr-1" title="Manually entered"></i>';
      }
      
      tableHtml += '<tr ' + rowClass + '>' +
        '<td>' +
        scanIcon +
        '<div><strong>' + book.description + '</strong></div>' +
        '<div class="small text-muted">' + (book.authors ? 'By: ' + book.authors : '') + '</div>' +
        '<div class="small text-muted">' + (book.categories ? 'Categories: ' + book.categories : '') + '</div>' +
        '</td>' +
        '<td>$' + parseFloat(book.price).toFixed(2) + '</td>' +
        '<td>' + book.quantity + '</td>' +
        '<td>$' + bookTotal.toFixed(2) + '</td>' +
        '<td>' +
        '<div class="btn-group btn-group-sm">' +
        '<button class="btn btn-info edit-quantity" data-index="' + index + '" title="Edit Quantity"><i class="fas fa-edit"></i></button>' +
        '<button class="btn btn-danger remove-book" data-index="' + index + '" title="Remove Book"><i class="fas fa-trash"></i></button>' +
        '</div>' +
        '</td>' +
        '</tr>';
    });
    
    tableHtml += '</tbody><tfoot>' +
      '<tr>' +
      '<td colspan="3" class="text-right"><strong>Grand Total:</strong></td>' +
      '<td colspan="2"><strong>$' + total.toFixed(2) + '</strong></td>' +
      '</tr>' +
      '</tfoot></table>';
    
    container.html(tableHtml);
    
    // Enable buttons
    $('#create-bill-button').prop('disabled', false);
    $('#clear-button').prop('disabled', false);
    
    // Bind event for quantity editing
    $('.edit-quantity').on('click', function() {
      var index = $(this).data('index');
      var book = scannedBooks[index];
      
      // Populate the modal
      $('#edit-book-title').val(book.description);
      $('#edit-book-index').val(index);
      $('#edit-book-quantity').val(book.quantity);
      
      // Show the modal
      $('#quantityModal').modal('show');
    });
    
    // Bind event for removing a book
    $('.remove-book').on('click', function() {
      var index = $(this).data('index');
      scannedBooks.splice(index, 1);
      updateScannedBooksList();
    });
  }
  
  // Create a bill from scanned books
  function createBillFromScannedBooks() {
    if (scannedBooks.length === 0) {
      toastr.warning('Please scan at least one book before creating a bill.');
      return;
    }
    
    var customerId = $('#customer-select').val();
    if (!customerId) {
      toastr.warning('Please select a customer before creating a bill.');
      return;
    }
    
    // Get customer name for the message
    var customerName = $('#customer-select option:selected').text();
    
    // Show loading indicator
    $('#loading-spinner').show();
    
    // Count camera-scanned books and manually entered books
    var cameraScannedCount = scannedBooks.filter(function(book) {
      return book.scanned_by === 'camera';
    }).length;
    
    var manuallyEnteredCount = scannedBooks.filter(function(book) {
      return book.scanned_by === 'manual';
    }).length;
    
    // Use the create_bill_from_scanned API endpoint
    $.ajax({
      url: '/api/create_bill_from_scanned/',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        customer_id: customerId,
        books: scannedBooks
      }),
      headers: {
        'X-CSRFToken': csrftoken
      },
      success: function(response) {
        if (response.success) {
          // Show detailed success message
          var totalBooks = scannedBooks.length;
          var successMessage = 'Bill #' + response.bill_id + ' created successfully for ' + customerName + 
                          ' with ' + totalBooks + ' books';
          
          // Add details about scanning method if relevant  
          var scanMethodDetails = [];
          if (cameraScannedCount > 0) {
            scanMethodDetails.push(cameraScannedCount + ' by camera');
          }
          if (manuallyEnteredCount > 0) {
            scanMethodDetails.push(manuallyEnteredCount + ' entered manually');
          }
          
          if (scanMethodDetails.length > 0) {
            successMessage += ' (' + scanMethodDetails.join(', ') + ')';
          }
          
          toastr.success(successMessage);
          clearScannedBooks();
          
          // Clear session storage
          sessionStorage.removeItem('scannedBooks');
          
          // If this is an AJAX page, load the bill list
          if (typeof loadContent === 'function') {
            loadContent("{% url 'bill_list' %}");
          } else {
            // Otherwise redirect to the bill list
            window.location.href = "{% url 'bill_list' %}";
          }
        } else {
          toastr.error('Error creating bill: ' + response.error);
        }
      },
      error: function(xhr) {
        console.error("Error creating bill:", xhr);
        toastr.error('Error creating bill. Please try again.');
      },
      complete: function() {
        $('#loading-spinner').hide();
      }
    });
  }
  
  // Clear scanned books
  function clearScannedBooks() {
    // Count different types of scanned books
    var cameraScannedBooks = scannedBooks.filter(function(book) {
      return book.scanned_by === 'camera';
    });
    
    var manuallyEnteredBooks = scannedBooks.filter(function(book) {
      return book.scanned_by === 'manual';
    });
    
    if (scannedBooks.length > 0) {
      var confirmMessage = 'Clear all ' + scannedBooks.length + ' books';
      
      var detailMessages = [];
      if (cameraScannedBooks.length > 0) {
        detailMessages.push(cameraScannedBooks.length + ' camera-scanned');
      }
      if (manuallyEnteredBooks.length > 0) {
        detailMessages.push(manuallyEnteredBooks.length + ' manually entered');
      }
      
      if (detailMessages.length > 0) {
        confirmMessage += ' (' + detailMessages.join(', ') + ')';
      }
      
      confirmMessage += '?';
      
      if (!confirm(confirmMessage)) {
        return;
      }
    }
    
    scannedBooks = [];
    
    // Clear from session storage
    sessionStorage.removeItem('scannedBooks');
    
    updateScannedBooksList();
    toastr.info('Book list has been cleared');
  }
  
  // Play sound for feedback
  function playSound(type) {
    // Use browser's built-in beep instead of audio files
    if (type === 'success') {
      // High-pitched beep for success
      try {
        var context = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = context.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = 1500;
        oscillator.connect(context.destination);
        oscillator.start();
        setTimeout(function() { oscillator.stop(); }, 200);
      } catch (e) {
        console.log("Audio not supported:", e);
      }
    } else {
      // Low-pitched beep for error
      try {
        var context = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = context.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = 300;
        oscillator.connect(context.destination);
        oscillator.start();
        setTimeout(function() { oscillator.stop(); }, 400);
      } catch (e) {
        console.log("Audio not supported:", e);
      }
    }
  }
});
</script>
{% endblock javascripts %} 