{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Scan Barcode {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<!-- Select2 -->
<link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
<!-- Toastr -->
<link rel="stylesheet" href="{% static 'plugins/toastr/toastr.min.css' %}">
<style>  /* Scanner viewport styling */
  #interactive.viewport {
    position: relative;
    width: 100%;
    height: 400px;
    overflow: hidden;
    text-align: center;
    border: 3px solid #007bff;
    border-radius: 20px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 8px 32px rgba(0, 123, 255, 0.2);
    position: relative;
    overflow: hidden;
  }
  
  #interactive.viewport::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
  }
  
  @keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%); }
    50% { transform: translateX(100%) translateY(100%); }
    100% { transform: translateX(-100%) translateY(-100%); }
  }
  
  #interactive.viewport img {
    max-width: 100%;
    max-height: 100%;
    border-radius: 15px;
    z-index: 2;
    position: relative;
  }
    /* Enhanced card styling with glassmorphism */
  .card {
    border: none;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
    position: relative;
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: all 0.6s;
  }
  
  .card:hover::before {
    left: 100%;
  }
  
  .card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(31, 38, 135, 0.4);
  }
  
  .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px 20px 0 0 !important;
    border: none;
    padding: 1.5rem 2rem;
    position: relative;
    overflow: hidden;
  }
  
  .card-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
    animation: headerShine 4s infinite;
  }
  
  @keyframes headerShine {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }
  
  .card-header h3 {
    margin: 0;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    font-size: 1.25rem;
    letter-spacing: 0.5px;
    z-index: 2;
    position: relative;
  }
  
  .card-body {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.9);
    position: relative;
  }
  
  /* Scanned books section */
  #scanned-books {
    max-height: 500px;
    overflow-y: auto;
    border-radius: 15px;
  }
  
  #scanned-books::-webkit-scrollbar {
    width: 12px;
  }
  
  #scanned-books::-webkit-scrollbar-track {
    background: linear-gradient(135deg, #f1f1f1 0%, #e9ecef 100%);
    border-radius: 15px;
  }
  
  #scanned-books::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    border: 2px solid #f1f1f1;
  }
  
  #scanned-books::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  }
    /* Enhanced table styling with modern design */
  .table {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    background: white;
    margin-bottom: 0;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .table thead th {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border: none;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 1px;
    padding: 1.25rem 1rem;
    position: relative;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
  
  .table thead th:first-child {
    border-top-left-radius: 15px;
  }
  
  .table thead th:last-child {
    border-top-right-radius: 15px;
  }
  
  .table tbody td {
    vertical-align: middle;
    padding: 1.25rem 1rem;
    border-color: rgba(0, 0, 0, 0.05);
    background: white;
    position: relative;
  }
  
  .table tbody tr {
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
  }
  
  .table tbody tr::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.3s ease;
  }
  
  .table tbody tr:hover::before {
    width: 4px;
  }
  
  .table tbody tr:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    transform: translateX(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  
  .table tfoot {
    background: linear-gradient(135deg, #10ac84 0%, #01a3a4 100%);
    color: white;
    font-weight: bold;
  }
  
  .table tfoot td {
    border: none;
    padding: 1.25rem 1rem;
    font-size: 1.1rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
  
  .table tfoot td:first-child {
    border-bottom-left-radius: 15px;
  }
  
  .table tfoot td:last-child {
    border-bottom-right-radius: 15px;
  }
    /* Advanced button enhancements with 3D effects */
  .btn {
    border-radius: 50px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  
  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: all 0.6s;
  }
  
  .btn:hover::before {
    left: 100%;
  }
  
  .btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }
  
  .btn:active {
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    color: white;
  }
  
  .btn-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }
  
  .btn-danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    color: white;
  }
  
  .btn-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }
  
  .btn-sm {
    padding: 0.5rem 1.5rem;
    font-size: 0.875rem;
  }
    /* Enhanced alert styling with modern design */
  .alert-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196f3;
    border-radius: 15px;
    padding: 1.5rem 2rem;
    color: #0d47a1;
    font-weight: 500;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
  }
  
  .alert-info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, #2196f3, #1976d2);
  }
  
  .alert-info i {
    color: #2196f3;
    margin-right: 0.75rem;
    font-size: 1.1rem;
  }
    /* Advanced form input styling */
  .form-control {
    border-radius: 15px;
    border: 2px solid #e0e0e0;
    padding: 1rem 1.5rem;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    font-weight: 500;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.25);
    transform: translateY(-2px) scale(1.02);
    background: white;
    outline: none;
  }
  
  .form-control::placeholder {
    color: #9e9e9e;
    font-style: italic;
  }
  
  .input-group .form-control {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    border-right: none;
  }
  
  .input-group .form-control:focus {
    border-right: 2px solid #667eea;
  }
  
  .input-group-append .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    border-top-right-radius: 15px;
    border-bottom-right-radius: 15px;
  }
  
  /* Enhanced select styling */
  select.form-control {
    background-image: linear-gradient(45deg, transparent 50%, #667eea 50%), linear-gradient(135deg, #667eea 50%, transparent 50%);
    background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px);
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
    padding-right: 2.5rem;
  }
  
  /* Number input styling */
  input[type="number"] {
    border-radius: 10px;
    border: 2px solid #e0e0e0;
    padding: 0.5rem;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  input[type="number"]:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    transform: scale(1.05);
  }
  
  /* Loading spinner */
  .loading-spinner {
    display: none;
    text-align: center;
    margin: 30px 0;
    position: relative;
  }
  
  .loading-spinner::before {
    content: '';
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Icon styling */
  .fas, .far {
    margin-right: 0.75rem;
    transition: all 0.3s ease;
  }
  
  .btn:hover .fas,
  .btn:hover .far {
    transform: scale(1.1);
  }
    /* Enhanced create bill section with modern styling */
  .create-bill-section {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border: 3px dashed #667eea;
    border-radius: 20px;
    padding: 2rem;
    margin: 1.5rem 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }
  
  .create-bill-section::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    animation: sectionShimmer 4s infinite;
  }
  
  @keyframes sectionShimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
  }
  
  .create-bill-section:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
    border-color: #764ba2;
  }
  
  .create-bill-section h6 {
    color: #667eea;
    font-weight: 700;
    margin-bottom: 1.5rem;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    z-index: 2;
    position: relative;
  }
  
  /* Enhanced empty state styling */
  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
    color: #9e9e9e;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
  }
  
  .empty-state::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%23667eea" opacity="0.1"><animate attributeName="opacity" dur="3s" repeatCount="indefinite" values="0.1;0.3;0.1"/></circle><circle cx="80" cy="80" r="2" fill="%23764ba2" opacity="0.1"><animate attributeName="opacity" dur="3s" repeatCount="indefinite" values="0.1;0.3;0.1" begin="1s"/></circle></svg>');
  }
  
  .empty-state i {
    opacity: 0.4;
    margin-bottom: 1.5rem;
    font-size: 4rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  
  .empty-state p {
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0;
    z-index: 2;
    position: relative;
  }
  
  /* Breadcrumb styling */
  .breadcrumb {
    background: transparent;
    padding: 0;
  }
  
  .breadcrumb-item + .breadcrumb-item::before {
    color: #6c757d;
  }
  
  /* Enhanced page title styling */
  .content-header h1 {
    color: #2c3e50;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    font-size: 2.5rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0;
    position: relative;
  }
  
  .content-header h1::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 2px;
  }
  
  /* Enhanced badge styling for scan methods */
  .scan-badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }
  
  /* Enhanced table row highlighting */
  .table-info {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%) !important;
    border-left: 4px solid #4facfe;
  }
  
  .table-warning {
    background: linear-gradient(135deg, rgba(240, 147, 251, 0.15) 0%, rgba(245, 87, 108, 0.15) 100%) !important;
    border-left: 4px solid #f093fb;
  }
  
  /* Enhanced modal styling */
  .modal-content {
    border-radius: 20px;
    border: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }
  
  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: none;
    padding: 1.5rem 2rem;
  }
  
  .modal-title {
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  
  .modal-body {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.95);
  }
  
  .modal-footer {
    background: rgba(248, 249, 250, 0.9);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1.5rem 2rem;
  }
  
  /* Debug section styling */
  .debug-section {
    background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.8) 100%);
    border: 2px dashed #667eea;
    border-radius: 15px;
    padding: 1.5rem;
    margin: 1rem 0;
    transition: all 0.3s ease;
  }
  
  .debug-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
  }
  
  .debug-section h6 {
    color: #667eea;
    font-weight: 600;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .debug-section select,
  .debug-section button {
    transition: all 0.3s ease;
  }
  
  .debug-section select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  /* Page title styling */
  .content-header h1 {
    color: #2c3e50;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  /* Badge styling for scan methods */
  .scan-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-weight: 500;
  }
  
  /* Row hover effects */
  .table-info {
    background-color: rgba(23, 162, 184, 0.1) !important;
  }
  
  .table-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .card-body {
      padding: 1rem;
    }
    
    .btn {
      padding: 0.375rem 1rem;
      font-size: 0.875rem;
    }
    
    .table thead th,
    .table tbody td {
      padding: 0.75rem 0.5rem;
      font-size: 0.875rem;
    }
  }
  
  /* Global background styling */
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
  }
  
  .content-wrapper {
    background: transparent;
  }
  
  /* Enhanced container styling */
  .container-fluid {
    position: relative;
  }
  
  /* Floating action effects */
  .card-tools .btn {
    margin-left: 0.5rem;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  .card-tools .btn:hover {
    transform: translateY(-3px) scale(1.1);
  }
  
  /* Enhanced text styling */
  .text-muted {
    color: #6c757d !important;
    font-weight: 500;
  }
  
  strong {
    font-weight: 700;
    color: #2c3e50;
  }
  
  /* Enhanced input group styling */
  .input-group {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .input-group:focus-within {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
  }
  
  /* Quantity input special styling */
  input[type="number"] {
    border-radius: 10px;
    border: 2px solid #e0e0e0;
    padding: 0.5rem;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
    background: white;
    width: 70px;
  }
  
  input[type="number"]:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    transform: scale(1.05);
    outline: none;
  }
  
  /* Enhanced alert responsiveness */
  @media (max-width: 768px) {
    .content-header h1 {
      font-size: 2rem;
    }
    
    .card-body {
      padding: 1.25rem;
    }
    
    .btn {
      padding: 0.5rem 1.5rem;
      font-size: 0.875rem;
    }
    
    .table thead th,
    .table tbody td {
      padding: 1rem 0.75rem;
      font-size: 0.875rem;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .alert-info {
      padding: 1.25rem 1.5rem;
    }
  }
  
  @media (max-width: 576px) {
    .content-header h1 {
      font-size: 1.75rem;
    }
    
    .card {
      margin-bottom: 1rem;
    }
    
    .btn {
      padding: 0.4rem 1.2rem;
      font-size: 0.8rem;
    }
    
    .table thead th,
    .table tbody td {
      padding: 0.75rem 0.5rem;
      font-size: 0.8rem;
    }
  }
</style>
{% endblock stylesheets %}

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Scan Barcode</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'bill_list' %}">Bills</a></li>
            <li class="breadcrumb-item active">Scan Barcode</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Barcode Scanner</h3>
              <div class="card-tools">
                <a href="{% url 'bill_list' %}" class="btn btn-default ajax-link">
                  <i class="fas fa-arrow-left"></i> Back to Bills
                </a>
                <a href="{% url 'bill_create' %}" class="btn btn-primary ajax-link">
                  <i class="fas fa-plus"></i> New Bill
                </a>
              </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
              <div class="row">
                <div class="col-md-7">
                  <!-- Scanner Section -->
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">
                        <i class="fas fa-camera"></i> Camera Feed
                      </h3>
                      <div class="card-tools">
                        <a href="{% url 'bill_scan_barcode_desktop' %}" class="btn btn-success btn-sm">
                          <i class="fas fa-play"></i> Start Scanner (Desktop)
                        </a>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Clicking "Start Scanner" will open the camera on the server computer. 
                        You will see a camera window where barcodes will be scanned. Press 'c' key to complete scanning and return to the web interface.
                      </div>
                        <form method="post" class="form-group mt-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_manual_barcode">
                        <label for="barcode-manual">Or enter barcode manually:</label>
                        <div class="input-group">
                          <input type="text" name="barcode_number" class="form-control" placeholder="Enter barcode number" required>
                          <div class="input-group-append">
                            <button type="submit" class="btn btn-primary">
                              <i class="fas fa-search"></i> Lookup
                            </button>
                          </div>
                        </div>
                      </form>
                      
                      <div class="mt-2">
                        <a href="{% url 'test_barcode_scan' %}" class="btn btn-info btn-sm">
                          <i class="fas fa-flask"></i> Test Scan (Demo)
                        </a>
                      </div>
                    </div>
                  </div>                  
                                 <!-- Scanned Books Section -->
                <div class="card">
                  <div class="card-header">                    <h3 class="card-title">
                      <i class="fas fa-list"></i> Scanned Books ({{ scanned_books_count }})
                    </h3>                    <div class="card-tools">
                      <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to clear all books?');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="clear_all">
                        <button type="submit" class="btn btn-warning btn-sm" {% if scanned_books_count == 0 %}disabled{% endif %}>
                          <i class="fas fa-trash"></i> Clear List
                        </button>
                      </form>
                    </div>
                  </div>
                  <div class="card-body">
                    {% if scanned_books %}
                      <table class="table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>Book</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Total</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for book in scanned_books %}
                          <tr {% if book.scanned_by == 'camera' %}class="table-info"{% elif book.scanned_by == 'manual' %}class="table-warning"{% endif %}>
                            <td>
                              {% if book.scanned_by == 'camera' %}
                                <i class="fas fa-camera text-info mr-1" title="Camera scanned"></i>
                              {% elif book.scanned_by == 'manual' %}
                                <i class="fas fa-keyboard text-warning mr-1" title="Manually entered"></i>
                              {% endif %}
                              <div><strong>{{ book.description }}</strong></div>
                              {% if book.authors %}
                                <div class="small text-muted">By: {% for author in book.authors %}{{ author }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                              {% endif %}
                              {% if book.categories %}
                                <div class="small text-muted">Categories: {% for category in book.categories %}{{ category }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                              {% endif %}
                            </td>                            <td>${{ book.price }}</td>
                            <td>
                              <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_quantity">
                                <input type="hidden" name="book_index" value="{{ forloop.counter0 }}">
                                <input type="number" name="quantity" value="{{ book.quantity }}" min="1" max="100" style="width: 60px;" onchange="this.form.submit();">
                              </form>
                            </td>
                            <td>${{ book.total|floatformat:2 }}</td>
                            <td>
                              <form method="post" style="display: inline;" onsubmit="return confirm('Remove this book?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="remove_book">
                                <input type="hidden" name="book_index" value="{{ forloop.counter0 }}">
                                <button type="submit" class="btn btn-danger btn-sm" title="Remove Book">
                                  <i class="fas fa-trash"></i>
                                </button>
                              </form>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                        <tfoot>
                          <tr>
                            <td colspan="3" class="text-right"><strong>Grand Total:</strong></td>
                            <td colspan="2"><strong>${{ total_amount|floatformat:2 }}</strong></td>
                          </tr>
                        </tfoot>
                      </table>                    {% else %}
                      <div class="empty-state">
                        <i class="fas fa-barcode fa-4x mb-3"></i>
                        <p>Scan a barcode or enter one manually to add books to your list.</p>
                        <small class="text-muted">Use the camera scanner or manual input above</small>
                      </div>
                    {% endif %}
                  </div>
                </div>
                      
                      <!-- Book Quantity Edit Modal -->
                      <div class="modal fade" id="quantityModal" tabindex="-1" role="dialog" aria-labelledby="quantityModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="quantityModalLabel">Edit Quantity</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                              <div class="form-group">
                                <label for="edit-book-title">Book:</label>
                                <input type="text" class="form-control" id="edit-book-title" readonly>
                                <input type="hidden" id="edit-book-index">
                              </div>
                              <div class="form-group">
                                <label for="edit-book-quantity">Quantity:</label>
                                <input type="number" class="form-control" id="edit-book-quantity" min="1" value="1">
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                              <button type="button" class="btn btn-primary" id="save-quantity">Save changes</button>
                            </div>
                          </div>
                        </div>
                      </div>                      </div>
                        <!-- Enhanced Create Bill Section -->
                      <div class="debug-section">
                        <h6><i class="fas fa-plus-circle"></i> Create Bill</h6>
                        <form method="post">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="create_bill">
                          <div class="form-group mb-3">
                            <label for="customer_select" class="form-label">
                              <i class="fas fa-user"></i> Select Customer:
                            </label>
                            <select name="customer_id" id="customer_select" class="form-control" required>
                              <option value="">Choose a customer...</option>
                              {% for customer in customers %}
                              <option value="{{ customer.id }}">{{ customer.cusname }} (ID: {{ customer.id }})</option>
                              {% endfor %}
                            </select>
                          </div>
                          <button type="submit" class="btn btn-success">
                            <i class="fas fa-receipt"></i> Create Bill
                          </button>
                        </form>
                      </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<!-- Select2 -->
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Toastr -->
<script src="{% static 'plugins/toastr/toastr.min.js' %}"></script>
<script>
// Configure toastr notifications
toastr.options = {
  "closeButton": true,
  "positionClass": "toast-top-right",
  "timeOut": "3000"
};

console.log("barcode_scanner.js loaded!");

$(function () {
  // Store scanned books
  var scannedBooks = [];
  
  // Extract CSRF token from the form
  var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();
  
  // Initialize Select2
  $('.select2').select2({
    theme: 'bootstrap4'
  });
  
  // Try to load books from session storage first
  var savedBooks = sessionStorage.getItem('scannedBooks');
  if (savedBooks) {
    try {
      scannedBooks = JSON.parse(savedBooks);
      updateScannedBooksList();
    } catch (e) {
      console.error("Error loading books from session storage:", e);
    }
  }    // Then check if there are desktop scanned books from Django
  {% if desktop_scanned_books_json %}
    console.log("Desktop scanned books JSON found!");
    console.log("Raw JSON:", '{{ desktop_scanned_books_json|safe }}');
    
    // Merge with existing books
    var desktopBooks = {{ desktop_scanned_books_json|safe }};
    console.log("Parsed desktop books:", desktopBooks);
    console.log("Number of desktop books:", desktopBooks.length);
    
    // Add desktop books that aren't already in the list
    desktopBooks.forEach(function(newBook) {
      console.log("Processing book:", newBook);
      var exists = false;
      for (var i = 0; i < scannedBooks.length; i++) {
        if (scannedBooks[i].id === newBook.id) {
          exists = true;
          // Update quantity if it exists
          scannedBooks[i].quantity += newBook.quantity;
          break;
        }
      }
      if (!exists) {
        // Add scanned_by property if not present
        if (!newBook.hasOwnProperty('scanned_by')) {
          newBook.scanned_by = 'camera';
        }
        console.log("Adding new book to scannedBooks array:", newBook);
        scannedBooks.push(newBook);
      }
    });
    
    console.log("Final scannedBooks array:", scannedBooks);
    updateScannedBooksList();
    toastr.success('Added ' + desktopBooks.length + ' camera-scanned books to the list');
  {% else %}
    console.log("No desktop scanned books JSON found");
  {% endif %}
  
  // Manual lookup form submission
  $('#manual-barcode-form').on('submit', function(e) {
    e.preventDefault(); // Prevent form submission
    var barcode = $('#barcode-manual').val().trim();
    if (barcode) {
      lookupBarcode(barcode);
      $('#barcode-manual').val('');
    }
    return false; // Ensure no submission occurs
  });
  
  // Manual lookup button click
  $('#lookup-barcode').on('click', function(e) {
    e.preventDefault(); // Prevent any default action
    var barcode = $('#barcode-manual').val().trim();
    if (barcode) {
      lookupBarcode(barcode);
      $('#barcode-manual').val('');
    } else {
      toastr.warning('Please enter a barcode number first');
    }
    return false; // Ensure no page refresh
  });
  
  // Also listen for keypress in the barcode input field
  $('#barcode-manual').on('keydown', function(e) {
    if (e.which === 13) { // Enter key
      e.preventDefault(); // Prevent form submission
      var barcode = $(this).val().trim();
      if (barcode) {
        lookupBarcode(barcode);
        $(this).val('');
      }
      return false; // Prevent default
    }  });    // Function to validate create bill form before submission (legacy - now handled by form submit handler)
  function validateCreateBill() {
    console.log('Legacy validateCreateBill called - this should not be used anymore');
    return true; // Allow submission since we handle validation in the form submit handler  }

  // Clear button
  $('#clear-button').on('click', function() {
    clearScannedBooks();
  });
  
  // Save quantity changes
  $('#save-quantity').on('click', function() {
    var index = parseInt($('#edit-book-index').val());
    var quantity = parseInt($('#edit-book-quantity').val());
    
    if (quantity >= 1 && index >= 0 && index < scannedBooks.length) {
      scannedBooks[index].quantity = quantity;
      $('#quantityModal').modal('hide');
      
      // Save to session storage
      sessionStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
      
      updateScannedBooksList();
      
      // Show success message
      toastr.success('Quantity updated successfully');
    }
  });
  
  // Handle Enter key in quantity input
  $('#edit-book-quantity').on('keypress', function(e) {
    if (e.which === 13) { // Enter key
      $('#save-quantity').click();
      e.preventDefault();
    }
  });
  
  // Lookup a barcode via API
  function lookupBarcode(barcode) {
    $('#loading-spinner').show();
    
    // Try the direct lookup first (no authentication needed)
    $.ajax({
      url: '/api/lookup_barcode/' + encodeURIComponent(barcode) + '/',
      type: 'GET',
      success: function(data) {
        if (data.success) {
          addBookToScannedList(data.book);
        } else {
          // Fall back to the POST method with CSRF
          lookupBarcodeWithPost(barcode);
        }
      },
      error: function(xhr) {
        // Fall back to the POST method with CSRF
        lookupBarcodeWithPost(barcode);
      },
      complete: function() {
        $('#loading-spinner').hide();
      }
    });
  }
  
  // Fallback method using POST with CSRF token
  function lookupBarcodeWithPost(barcode) {
    $.ajax({
      url: '/api/process_barcode/',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        barcode: barcode
      }),
      headers: {
        'X-CSRFToken': csrftoken
      },
      success: function(data) {
        if (data.success) {
          addBookToScannedList(data.book);
        } else {
          console.error("Invalid barcode response:", data);
          toastr.error("Could not find book with barcode: " + barcode);
          playSound('error');
        }
      },
      error: function(xhr) {
        console.error("Error looking up barcode:", xhr);
        toastr.error("Error looking up barcode: " + barcode);
        playSound('error');
      },
      complete: function() {
        $('#loading-spinner').hide();
      }
    });
  }
  
  // Function to add a book to the scanned list
  function addBookToScannedList(book) {
    // Check if book is already in the list
    var bookExists = false;
    for (var i = 0; i < scannedBooks.length; i++) {
      if (scannedBooks[i].id === book.id) {
        // Increment quantity instead of adding again
        scannedBooks[i].quantity++;
        bookExists = true;
        
        // Show notification for quantity update
        toastr.info('Updated quantity for "' + scannedBooks[i].description + '" to ' + scannedBooks[i].quantity);
        break;
      }
    }
    
    if (!bookExists) {
      // Add book to the list
      var newBook = {
        id: book.id,
        description: book.description,
        price: book.price,
        quantity: 1,
        publisher: book.publisher,
        authors: Array.isArray(book.authors) ? book.authors.join(', ') : book.authors,
        categories: Array.isArray(book.categories) ? book.categories.join(', ') : book.categories,
        scanned_by: 'manual'  // Track how this book was added
      };
      
      scannedBooks.push(newBook);
      
      // Show notification for new book
      toastr.success('Added "' + newBook.description + '" to list');
    }
    
    // Save to session storage
    sessionStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
    
    // Update the display
    updateScannedBooksList();
    
    // Play success sound
    playSound('success');
  }
    // Update the scanned books list
  function updateScannedBooksList() {
    console.log("updateScannedBooksList called with:", scannedBooks);
    var container = $('#scanned-books');
    container.empty();
    
    if (scannedBooks.length === 0) {
      console.log("No scanned books, showing empty message");
      container.html('<div class="text-muted text-center"><i class="fas fa-barcode fa-3x mb-3"></i><p>Scan a barcode to add books to the list.</p></div>');
      $('#create-bill-button').prop('disabled', true);
      $('#clear-button').prop('disabled', true);
      
      // Clear session storage when list is empty
      sessionStorage.removeItem('scannedBooks');
      return;
    }
    
    console.log("Building table for", scannedBooks.length, "books");
    
    // Save to session storage
    sessionStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
    
    // Create a table to display books
    var tableHtml = '<table class="table table-striped table-hover">' +
      '<thead>' +
      '<tr>' +
      '<th>Book</th>' +
      '<th>Price</th>' +
      '<th>Qty</th>' +
      '<th>Total</th>' +
      '<th>Actions</th>' +
      '</tr>' +
      '</thead>' +
      '<tbody>';
    
    var total = 0;
    
    scannedBooks.forEach(function(book, index) {
      var bookTotal = parseFloat(book.price) * book.quantity;
      total += bookTotal;
      
      // Add a class for camera-scanned books
      var rowClass = '';
      var scanIcon = '';
      
      if (book.scanned_by === 'camera') {
        rowClass = 'class="table-info"';
        scanIcon = '<i class="fas fa-camera text-info mr-1" title="Camera scanned"></i>';
      } else if (book.scanned_by === 'manual') {
        rowClass = 'class="table-warning"';
        scanIcon = '<i class="fas fa-keyboard text-warning mr-1" title="Manually entered"></i>';
      }
      
      tableHtml += '<tr ' + rowClass + '>' +
        '<td>' +
        scanIcon +
        '<div><strong>' + book.description + '</strong></div>' +
        '<div class="small text-muted">' + (book.authors ? 'By: ' + book.authors : '') + '</div>' +
        '<div class="small text-muted">' + (book.categories ? 'Categories: ' + book.categories : '') + '</div>' +
        '</td>' +
        '<td>$' + parseFloat(book.price).toFixed(2) + '</td>' +
        '<td>' + book.quantity + '</td>' +
        '<td>$' + bookTotal.toFixed(2) + '</td>' +
        '<td>' +
        '<div class="btn-group btn-group-sm">' +
        '<button class="btn btn-info edit-quantity" data-index="' + index + '" title="Edit Quantity"><i class="fas fa-edit"></i></button>' +
        '<button class="btn btn-danger remove-book" data-index="' + index + '" title="Remove Book"><i class="fas fa-trash"></i></button>' +
        '</div>' +
        '</td>' +
        '</tr>';
    });
    
    tableHtml += '</tbody><tfoot>' +
      '<tr>' +
      '<td colspan="3" class="text-right"><strong>Grand Total:</strong></td>' +
      '<td colspan="2"><strong>$' + total.toFixed(2) + '</strong></td>' +
      '</tr>' +
      '</tfoot></table>';
    
    container.html(tableHtml);
    
    // Enable buttons
    $('#create-bill-button').prop('disabled', false);
    $('#clear-button').prop('disabled', false);
    
    // Bind event for quantity editing
    $('.edit-quantity').on('click', function() {
      var index = $(this).data('index');
      var book = scannedBooks[index];
      
      // Populate the modal
      $('#edit-book-title').val(book.description);
      $('#edit-book-index').val(index);
      $('#edit-book-quantity').val(book.quantity);
      
      // Show the modal
      $('#quantityModal').modal('show');
    });
    
    // Bind event for removing a book
    $('.remove-book').on('click', function() {
      var index = $(this).data('index');
      scannedBooks.splice(index, 1);
      updateScannedBooksList();
    });
  }
  
  // Create a bill from scanned books
  function createBillFromScannedBooks() {
    if (scannedBooks.length === 0) {
      toastr.warning('Please scan at least one book before creating a bill.');
      return;
    }
    
    var customerId = $('#customer-select').val();
    if (!customerId) {
      toastr.warning('Please select a customer before creating a bill.');
      return;
    }
    
    // Get customer name for the message
    var customerName = $('#customer-select option:selected').text();
    
    // Show loading indicator
    $('#loading-spinner').show();
    
    // Count camera-scanned books and manually entered books
    var cameraScannedCount = scannedBooks.filter(function(book) {
      return book.scanned_by === 'camera';
    }).length;
    
    var manuallyEnteredCount = scannedBooks.filter(function(book) {
      return book.scanned_by === 'manual';
    }).length;
    
    // Use the create_bill_from_scanned API endpoint
    $.ajax({
      url: '/api/create_bill_from_scanned/',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        customer_id: customerId,
        books: scannedBooks
      }),
      headers: {
        'X-CSRFToken': csrftoken
      },
      success: function(response) {
        if (response.success) {
          // Show detailed success message
          var totalBooks = scannedBooks.length;
          var successMessage = 'Bill #' + response.bill_id + ' created successfully for ' + customerName + 
                          ' with ' + totalBooks + ' books';
          
          // Add details about scanning method if relevant  
          var scanMethodDetails = [];
          if (cameraScannedCount > 0) {
            scanMethodDetails.push(cameraScannedCount + ' by camera');
          }
          if (manuallyEnteredCount > 0) {
            scanMethodDetails.push(manuallyEnteredCount + ' entered manually');
          }
          
          if (scanMethodDetails.length > 0) {
            successMessage += ' (' + scanMethodDetails.join(', ') + ')';
          }
          
          toastr.success(successMessage);
          clearScannedBooks();
          
          // Clear session storage
          sessionStorage.removeItem('scannedBooks');
          
          // If this is an AJAX page, load the bill list
          if (typeof loadContent === 'function') {
            loadContent("{% url 'bill_list' %}");
          } else {
            // Otherwise redirect to the bill list
            window.location.href = "{% url 'bill_list' %}";
          }
        } else {
          toastr.error('Error creating bill: ' + response.error);
        }
      },
      error: function(xhr) {
        console.error("Error creating bill:", xhr);
        toastr.error('Error creating bill. Please try again.');
      },
      complete: function() {
        $('#loading-spinner').hide();
      }
    });
  }
  
  // Clear scanned books
  function clearScannedBooks() {
    // Count different types of scanned books
    var cameraScannedBooks = scannedBooks.filter(function(book) {
      return book.scanned_by === 'camera';
    });
    
    var manuallyEnteredBooks = scannedBooks.filter(function(book) {
      return book.scanned_by === 'manual';
    });
    
    if (scannedBooks.length > 0) {
      var confirmMessage = 'Clear all ' + scannedBooks.length + ' books';
      
      var detailMessages = [];
      if (cameraScannedBooks.length > 0) {
        detailMessages.push(cameraScannedBooks.length + ' camera-scanned');
      }
      if (manuallyEnteredBooks.length > 0) {
        detailMessages.push(manuallyEnteredBooks.length + ' manually entered');
      }
      
      if (detailMessages.length > 0) {
        confirmMessage += ' (' + detailMessages.join(', ') + ')';
      }
      
      confirmMessage += '?';
      
      if (!confirm(confirmMessage)) {
        return;
      }
    }
    
    scannedBooks = [];
    
    // Clear from session storage
    sessionStorage.removeItem('scannedBooks');
    
    updateScannedBooksList();
    toastr.info('Book list has been cleared');
  }
  
  // Play sound for feedback
  function playSound(type) {
    // Use browser's built-in beep instead of audio files
    if (type === 'success') {
      // High-pitched beep for success
      try {
        var context = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = context.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = 1500;
        oscillator.connect(context.destination);
        oscillator.start();
        setTimeout(function() { oscillator.stop(); }, 200);
      } catch (e) {
        console.log("Audio not supported:", e);
      }
    } else {
      // Low-pitched beep for error
      try {
        var context = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = context.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = 300;
        oscillator.connect(context.destination);
        oscillator.start();
        setTimeout(function() { oscillator.stop(); }, 400);
      } catch (e) {
        console.log("Audio not supported:", e);
      }
    }
  }
});
</script>
{% endblock javascripts %}