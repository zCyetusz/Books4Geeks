{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Inventory Analytics {% endblock title %}

{% block bodyclass %} hold-transition sidebar-mini {% endblock bodyclass %}

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Inventory Analytics</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'dashboardv3' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inventory_alerts' %}">Inventory</a></li>
            <li class="breadcrumb-item active">Analytics</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      
      {% if error %}
      <div class="alert alert-danger">
        <h5><i class="icon fas fa-ban"></i> Error!</h5>
        {{ error }}
      </div>
      {% endif %}

      {% if analyzing_specific_book %}
      <!-- Specific Book Analysis -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-book"></i>
                Analysis for: {{ book.bookname|default:"Book "|add:book.id }}
              </h3>
              <div class="card-tools">
                <a href="{% url 'inventory_analytics' %}" class="btn btn-secondary btn-sm">
                  <i class="fas fa-arrow-left"></i> Back to Overview
                </a>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Velocity Analysis -->
                <div class="col-md-6">
                  <h5>Sales Velocity Analysis</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th>Period</th>
                          <th>Total Sold</th>
                          <th>Daily Velocity</th>
                          <th>Weekly Velocity</th>
                          <th>Transactions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><strong>30 Days</strong></td>
                          <td>{{ velocity_data.total_sold }}</td>
                          <td>{{ velocity_data.daily_velocity }}</td>
                          <td>{{ velocity_data.weekly_velocity }}</td>
                          <td>{{ velocity_data.transactions_count }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Seasonal Patterns -->
                <div class="col-md-6">
                  <h5>Seasonal Patterns</h5>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <tr>
                        <td>Current Month Multiplier:</td>
                        <td><strong>{{ seasonal_data.seasonal_multiplier }}x</strong></td>
                      </tr>
                      <tr>
                        <td>Yearly Average:</td>
                        <td>{{ seasonal_data.yearly_average }} units/month</td>
                      </tr>
                      <tr>
                        <td>Peak Sales Month:</td>
                        <td>{{ seasonal_data.seasonal_data|dictsort:"month"|dictsort:"avg_sales"|last.month_name }}</td>
                      </tr>
                      <tr>
                        <td>Lowest Sales Month:</td>
                        <td>{{ seasonal_data.seasonal_data|dictsort:"month"|dictsort:"avg_sales"|first.month_name }}</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Monthly Sales Chart -->
              <div class="row mt-4">
                <div class="col-12">
                  <h5>Monthly Sales Pattern</h5>
                  <canvas id="seasonalChart" height="100"></canvas>
                </div>
              </div>

              <!-- Lead Time & Recommendation -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <h5>Supplier Lead Time</h5>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <tr>
                        <td>Average Lead Time:</td>
                        <td><strong>{{ lead_time_data.avg_lead_time }} days</strong></td>
                      </tr>
                      <tr>
                        <td>Range:</td>
                        <td>{{ lead_time_data.min_lead_time }} - {{ lead_time_data.max_lead_time }} days</td>
                      </tr>
                      <tr>
                        <td>Confidence Level:</td>
                        <td>
                          <span class="badge {% if lead_time_data.confidence == 'high' %}badge-success{% elif lead_time_data.confidence == 'medium' %}badge-warning{% else %}badge-secondary{% endif %}">
                            {{ lead_time_data.confidence|title }}
                          </span>
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>

                <div class="col-md-6">
                  {% if recommendation %}
                  <h5>Smart Recommendation</h5>
                  <div class="alert alert-{% if recommendation.urgency_level == 'CRITICAL' %}danger{% elif recommendation.urgency_level == 'HIGH' %}warning{% else %}info{% endif %}">
                    <h6>
                      <i class="fas fa-lightbulb"></i> 
                      {{ recommendation.urgency_level }} Priority
                    </h6>
                    <p><strong>Order {{ recommendation.suggested_order_qty }} units</strong></p>
                    <p>Current Stock: {{ recommendation.current_stock }}</p>
                    <p>Reorder Point: {{ recommendation.reorder_point }}</p>
                    <p><small>{{ recommendation.recommendation_reason }}</small></p>
                  </div>
                  {% else %}
                  <h5>Smart Recommendation</h5>
                  <div class="alert alert-success">
                    <h6><i class="fas fa-check"></i> Stock Level OK</h6>
                    <p>No immediate restocking needed based on current sales patterns.</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% else %}
      <!-- General Analytics Overview -->
      <div class="row">
        <!-- Summary Cards -->
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ report.summary.total_books_analyzed }}</h3>
              <p>Books Analyzed</p>
            </div>
            <div class="icon">
              <i class="fas fa-books"></i>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-6">
          <div class="small-box bg-danger">
            <div class="inner">
              <h3>{{ report.summary.critical_alerts }}</h3>
              <p>Critical Alerts</p>
            </div>
            <div class="icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ report.summary.high_alerts }}</h3>
              <p>High Priority</p>
            </div>
            <div class="icon">
              <i class="fas fa-exclamation"></i>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3>{{ report.summary.total_suggested_order_qty }}</h3>
              <p>Total Order Qty</p>
            </div>
            <div class="icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Top Performing Books -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                Top Performing Books (Last 30 Days)
              </h3>
            </div>
            <div class="card-body">
              {% if top_books_data %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Book</th>
                      <th>Total Sold</th>
                      <th>Daily Velocity</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in top_books_data %}
                    <tr>
                      <td>
                        <strong>{{ item.book.bookname|default:"Book "|add:item.book.id }}</strong>
                      </td>
                      <td>{{ item.total_sold }}</td>
                      <td>{{ item.velocity_data.daily_velocity }}</td>
                      <td>
                        <a href="{% url 'inventory_analytics' %}?book_id={{ item.book.id }}" class="btn btn-sm btn-info">
                          <i class="fas fa-chart-line"></i> Analyze
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <p class="text-muted">No sales data available for the last 30 days.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Alerts by Publisher -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-building"></i>
                Alerts by Publisher
              </h3>
            </div>
            <div class="card-body">
              {% if report.alerts_by_publisher %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Publisher</th>
                      <th>Alert Count</th>
                      <th>Total Order Qty</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for publisher, alerts in report.alerts_by_publisher.items %}
                    <tr>
                      <td>{{ publisher }}</td>
                      <td>
                        <span class="badge badge-warning">{{ alerts|length }}</span>
                      </td>
                      <td>
                        {% with total_qty=0 %}
                          {% for alert in alerts %}
                            {% with total_qty=total_qty|add:alert.suggested_order_qty %}{% endwith %}
                          {% endfor %}
                          {{ total_qty }}
                        {% endwith %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <p class="text-muted">No alerts by publisher data available.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Most Urgent Alerts -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-exclamation-triangle"></i>
                Most Urgent Restock Alerts
              </h3>
              <div class="card-tools">
                <a href="{% url 'inventory_alerts' %}" class="btn btn-primary btn-sm">
                  <i class="fas fa-list"></i> View All Alerts
                </a>
              </div>
            </div>
            <div class="card-body">
              {% if report.recommendations %}
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Book</th>
                      <th>Current Stock</th>
                      <th>Daily Velocity</th>
                      <th>Suggested Order</th>
                      <th>Urgency</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for rec in report.recommendations|slice:":10" %}
                    <tr>
                      <td>
                        <strong>{{ rec.book_name }}</strong><br>
                        <small class="text-muted">{{ rec.publisher_name }}</small>
                      </td>
                      <td>
                        <span class="badge {% if rec.current_stock <= 0 %}badge-danger{% elif rec.current_stock <= 5 %}badge-warning{% else %}badge-info{% endif %}">
                          {{ rec.current_stock }}
                        </span>
                      </td>
                      <td>{{ rec.daily_velocity }}/day</td>
                      <td><strong>{{ rec.suggested_order_qty }}</strong> units</td>
                      <td>
                        <span class="badge 
                          {% if rec.urgency_level == 'CRITICAL' %}badge-danger
                          {% elif rec.urgency_level == 'HIGH' %}badge-warning
                          {% elif rec.urgency_level == 'MEDIUM' %}badge-info
                          {% else %}badge-success{% endif %}">
                          {{ rec.urgency_level }}
                        </span>
                      </td>
                      <td>
                        <a href="{% url 'inventory_analytics' %}?book_id={{ rec.book_id }}" class="btn btn-sm btn-info">
                          <i class="fas fa-chart-line"></i> Analyze
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="text-center">
                <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                <h4 class="mt-3">No Urgent Alerts</h4>
                <p class="text-muted">All books are adequately stocked.</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </section>
</div>
{% endblock content %}

{% block extra_scripts %}
{% if analyzing_specific_book %}
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<script>
$(document).ready(function() {
  // Create seasonal chart
  const seasonalData = {{ seasonal_data.seasonal_data|safe }};
  const months = [];
  const avgSales = [];
  
  for (let month = 1; month <= 12; month++) {
    months.push(seasonalData[month].month_name);
    avgSales.push(seasonalData[month].avg_sales);
  }
  
  const ctx = document.getElementById('seasonalChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Average Monthly Sales',
        data: avgSales,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Seasonal Sales Pattern'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Average Units Sold'
          }
        }
      }
    }
  });
});
</script>
{% endif %}
{% endblock extra_scripts %}
